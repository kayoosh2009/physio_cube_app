<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Physio Cube – Settings</title>
    <link rel="icon" href="https://i.ibb.co/kgKXMwgq/round.png" type="image/x-icon">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <style>
        :root{
            --accent: #0794ae;
            --danger: #e74c3c;
            --bg-body: #f0f2f5;
            --bg-app: #ffffff;
            --text-main: #333;
            --text-light: #666;
            --border: #e0e0e0;
            --surface: #f8f9fa;
        }

        * { margin:0; padding:0; box-sizing:border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: var(--bg-body);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            color: var(--text-main);
        }

        /* --- Mobile Wrapper --- */
        .mobile-viewport {
            width: 100%;
            max-width: 420px;
            height: 100%;
            max-height: 900px;
            background: var(--bg-app);
            position: relative;
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        @media (max-width: 480px) {
            body { background: var(--bg-app); }
            .mobile-viewport { max-width: 100%; max-height: 100%; box-shadow: none; }
        }

        /* --- Navbar --- */
        .navbar {
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 15px;
            background: #fff;
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
            position: relative;
        }

        .back-btn {
            position: absolute;
            left: 15px;
            background: none;
            border: none;
            color: var(--accent);
            cursor: pointer;
            padding: 5px;
            display: flex;
            align-items: center;
        }

        .navbar h1 {
            font-size: 1.1rem;
            font-weight: 600;
        }

        /* --- Content --- */
        .content-scroll {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            -webkit-overflow-scrolling: touch;
        }

        /* --- Settings Sections --- */
        .settings-section {
            background: #fff;
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.03);
        }

        .section-title {
            font-size: 1rem;
            font-weight: 700;
            color: var(--accent);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .input-group {
            margin-bottom: 15px;
        }
        .input-group label {
            display: block;
            font-size: 0.85rem;
            color: var(--text-light);
            margin-bottom: 5px;
        }
        .input-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            background: #fafafa;
            transition: border 0.2s;
        }
        .input-group input:focus {
            outline: none;
            border-color: var(--accent);
            background: #fff;
        }

        .btn-save {
            width: 100%;
            padding: 12px;
            background: var(--text-main);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.95rem;
        }
        .btn-save:hover { opacity: 0.9; }

        .btn-save-secondary {
            background: var(--accent);
        }

        /* --- Logout Button --- */
        .logout-container {
            margin-top: 30px;
            margin-bottom: 20px;
            text-align: center;
        }
        .btn-logout {
            background: transparent;
            border: 1px solid var(--danger);
            color: var(--danger);
            padding: 12px 30px;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
        }
        .btn-logout:hover {
            background: #fff5f5;
        }

        /* --- Loader --- */
        #loader {
            position: absolute; inset: 0; background: white; z-index: 50;
            display: flex; justify-content: center; align-items: center;
            flex-direction: column; gap: 10px; color: var(--accent);
        }
        .spinner {
            width: 30px; height: 30px; border: 3px solid #f3f3f3;
            border-top: 3px solid var(--accent); border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    </style>
</head>

<body>

    <div class="mobile-viewport">
        
        <header class="navbar">
            <button class="back-btn" onclick="window.location.href='../dash.html'">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M15 18L9 12L15 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>
            <h1>Settings</h1>
        </header>

        <div id="loader">
            <div class="spinner"></div>
        </div>

        <main class="content-scroll" style="display:none;" id="mainContent">
            
            <div class="settings-section">
                <div class="section-title">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.05 12.05 0 0 0 .57 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.03 12.03 0 0 0 2.81.57A2 2 0 0 1 22 16.92z"></path>
                    </svg>
                    Contact & Notifications
                </div>
                
                <div class="input-group">
                    <label for="whatsapp">WhatsApp Number</label>
                    <input type="tel" id="whatsapp" placeholder="+972 50 123 4567">
                </div>

                <div class="input-group">
                    <label for="backupEmail">Additional Email</label>
                    <input type="email" id="backupEmail" placeholder="backup@example.com">
                </div>

                <button class="btn-save btn-save-secondary" id="saveContactBtn">Save Contact Info</button>
            </div>

            <div class="settings-section">
                <div class="section-title">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                        <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                    </svg>
                    Security
                </div>

                <div class="input-group">
                    <label for="newPassword">New Password</label>
                    <input type="password" id="newPassword" placeholder="Minimum 6 characters">
                </div>

                <button class="btn-save" id="updatePassBtn">Update Password</button>
            </div>

            <div class="logout-container">
                <button class="btn-logout" id="logoutBtn">Log Out</button>
            </div>

        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, updatePassword, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB8DZm6yDyGHD9rWo-bIhsipsKeMXCTcBk",
            authDomain: "physio-cube.firebaseapp.com",
            projectId: "physio-cube",
            storageBucket: "physio-cube.firebasestorage.app",
            messagingSenderId: "593288932552",
            appId: "1:593288932552:web:3b4783b6c16fef9eae09fd",
            measurementId: "G-F5W17MVEZD"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // UI References
        const loader = document.getElementById('loader');
        const mainContent = document.getElementById('mainContent');
        const whatsappInput = document.getElementById('whatsapp');
        const backupEmailInput = document.getElementById('backupEmail');
        
        let currentUser = null;

        // 1. Проверка авторизации и загрузка данных
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                try {
                    // Загружаем текущие настройки из Firestore
                    const docRef = doc(db, "users", user.uid);
                    const docSnap = await getDoc(docRef);

                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        if (data.whatsapp) whatsappInput.value = data.whatsapp;
                        if (data.backupEmail) backupEmailInput.value = data.backupEmail;
                    }
                } catch (e) {
                    console.error("Error loading settings:", e);
                } finally {
                    loader.style.display = 'none';
                    mainContent.style.display = 'block';
                }
            } else {
                window.location.href = 'login.html';
            }
        });

        // 2. Сохранение контактов (WhatsApp + Email)
        document.getElementById('saveContactBtn').addEventListener('click', async () => {
            const btn = document.getElementById('saveContactBtn');
            btn.textContent = "Saving...";
            btn.disabled = true;

            try {
                const userRef = doc(db, "users", currentUser.uid);
                await updateDoc(userRef, {
                    whatsapp: whatsappInput.value.trim(),
                    backupEmail: backupEmailInput.value.trim()
                });
                alert("Contact information updated!");
            } catch (error) {
                console.error("Error updating contacts:", error);
                alert("Failed to save data.");
            } finally {
                btn.textContent = "Save Contact Info";
                btn.disabled = false;
            }
        });

        // 3. Обновление пароля
        document.getElementById('updatePassBtn').addEventListener('click', async () => {
            const newPass = document.getElementById('newPassword').value;
            const btn = document.getElementById('updatePassBtn');

            if (newPass.length < 6) {
                alert("Password must be at least 6 characters.");
                return;
            }

            btn.textContent = "Updating...";
            btn.disabled = true;

            try {
                await updatePassword(currentUser, newPass);
                alert("Password updated successfully!");
                document.getElementById('newPassword').value = ""; // Очистить поле
            } catch (error) {
                console.error("Error changing password:", error);
                // Firebase требует недавнего входа для смены пароля
                if (error.code === 'auth/requires-recent-login') {
                    alert("For security reasons, please Log Out and Log In again to change your password.");
                } else {
                    alert("Error: " + error.message);
                }
            } finally {
                btn.textContent = "Update Password";
                btn.disabled = false;
            }
        });

        // 4. Логаут
        document.getElementById('logoutBtn').addEventListener('click', () => {
            signOut(auth).then(() => {
                window.location.href = 'login.html';
            }).catch((error) => {
                console.error("Logout error", error);
            });
        });

    </script>
</body>
</html>
